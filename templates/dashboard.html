<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Operacional CBMPE</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <style>
        :root { --azul: #3155A4; --vermelho: #AA4400; }
        body { background-color: #f4f6f8; }
        .sidebar-filters { background: white; border-right: 1px solid #ddd; min-height: 100vh; padding: 20px; }
        .chart-container { position: relative; height: 300px; width: 100%; } 
        .card-kpi { border-radius: 8px; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        /* Ajuste do Tom Select */
        .ts-wrapper.multi .ts-control > div { background: var(--azul); color: white; border-radius: 3px; }
    </style>
</head>
<body>

    <div class="container-fluid">
        <div class="row">
            
            <div class="col-md-2 sidebar-filters">
                <h5 class="text-primary fw-bold mb-3"><i class="bi bi-funnel"></i> Filtros</h5>
                
                <form action="/" method="GET" id="filterForm">
                    
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Ano</label>
                        <select name="ano" class="tom-select" multiple placeholder="Selecione...">
                            <option value="Todos" {% if not filtros_ativos.getlist('ano') or 'Todos' in filtros_ativos.getlist('ano') %}selected{% endif %}>Todos</option>
                            {% for a in anos %}
                            <option value="{{ a }}" {% if a|string in filtros_ativos.getlist('ano') %}selected{% endif %}>{{ a }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Natureza</label>
                        <select name="grupo" class="tom-select" multiple placeholder="Selecione...">
                            <option value="Todos" {% if not filtros_ativos.getlist('grupo') or 'Todos' in filtros_ativos.getlist('grupo') %}selected{% endif %}>Todas</option>
                            {% for g in grupos %}
                            <option value="{{ g }}" {% if g in filtros_ativos.getlist('grupo') %}selected{% endif %}>{{ g.replace('_', ' ') }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">Região</label>
                        <select name="regiao" class="tom-select" multiple placeholder="Selecione...">
                            <option value="Todos" {% if not filtros_ativos.getlist('regiao') or 'Todos' in filtros_ativos.getlist('regiao') %}selected{% endif %}>Todas</option>
                            {% for r in regioes %}
                            <option value="{{ r }}" {% if r in filtros_ativos.getlist('regiao') %}selected{% endif %}>{{ r }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="form-label small fw-bold">Gravidade</label>
                        <select name="gravidade" class="tom-select" multiple placeholder="Selecione...">
                            <option value="Todos" {% if not filtros_ativos.getlist('gravidade') or 'Todos' in filtros_ativos.getlist('gravidade') %}selected{% endif %}>Todos</option>
                            <option value="0" {% if '0' in filtros_ativos.getlist('gravidade') %}selected{% endif %}>Normal</option>
                            <option value="1" {% if '1' in filtros_ativos.getlist('gravidade') %}selected{% endif %}>Nível 1 (5+)</option>
                            <option value="2" {% if '2' in filtros_ativos.getlist('gravidade') %}selected{% endif %}>Nível 2 (10+)</option>
                        </select>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-sm fw-bold">
                            <i class="bi bi-check-lg"></i> Aplicar
                        </button>
                        
                        <a href="/" class="btn btn-outline-secondary btn-sm">Limpar Filtros</a>
                        <hr>
                        <a href="/predicao" class="btn btn-danger btn-sm fw-bold"><i class="bi bi-robot"></i> Ir para Modelo Preditivo</a>
                    </div>
                </form>
            </div>

            <div class="col-md-10 p-4">
                <h3 class="mb-4 fw-bold text-secondary">Dashboard Operacional</h3>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card card-kpi p-3 border-start border-5 border-primary">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted text-uppercase small">Total</h6>
                                    <h2 class="fw-bold mb-0">{{ total }}</h2>
                                </div>
                                <i class="bi bi-archive text-primary opacity-25 display-4"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card card-kpi p-3 border-start border-5 border-danger">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted text-uppercase small">Vítimas no Período</h6>
                                    <h2 class="fw-bold mb-0 text-danger">{{ vitimas }}</h2>
                                </div>
                                <i class="bi bi-activity text-danger opacity-25 display-4"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="card shadow-sm h-100 p-3">
                            <h6 class="fw-bold small text-center mb-3">Distribuição Regional</h6>
                            <div class="chart-container"><canvas id="chartRegiao"></canvas></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card shadow-sm h-100 p-3">
                            <h6 class="fw-bold small text-center mb-3">Ocorrências por Natureza</h6>
                            <div class="chart-container"><canvas id="chartNatureza"></canvas></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card shadow-sm h-100 p-3">
                            <h6 class="fw-bold small text-center mb-3">Nível de Gravidade</h6>
                            <div class="chart-container"><canvas id="chartGravidade"></canvas></div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-white fw-bold">Detalhamento Recente</div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 small align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Data</th>
                                    <th>Região</th>
                                    <th>Natureza</th>
                                    <th>Relato</th>
                                    <th>Vítimas</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for o in ultimas %}
                                <tr>
                                    <td>{{ o.data_ocorrencia.strftime('%d/%m/%Y %H:%M') }}</td>
                                    <td><span class="badge bg-secondary">{{ o.regiao_operacional }}</span></td>
                                    <td>{{ o.natureza.grupo.replace('_', ' ') }}</td>
                                    <td class="text-muted fst-italic text-truncate" style="max-width: 200px;">{{ o.natureza.natureza_inicial_aviso }}</td>
                                    <td>{% if o.acidente_massivo.vitimas > 0 %}<span class="fw-bold text-danger">{{ o.acidente_massivo.vitimas }}</span>{% else %}-{% endif %}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuração dos Filtros (Tom Select) ---
        document.querySelectorAll('.tom-select').forEach((el) => {
            new TomSelect(el, {
                plugins: ['remove_button'],
                maxItems: null,
                closeAfterSelect: false,
                onItemAdd: function(value) {
                    if (value === 'Todos') {
                        this.clear(true);
                        this.addItem('Todos', true);
                    } else {
                        if (this.items.includes('Todos')) {
                            this.removeItem('Todos', true);
                        }
                    }
                },
                onItemRemove: function(value) {
                    if (this.items.length === 0) {
                        this.addItem('Todos', true);
                    }
                }
            });
        });

        // --- Configurações Globais dos Gráficos ---
        Chart.register(ChartDataLabels);
        Chart.defaults.font.family = "'Segoe UI', sans-serif";
        Chart.defaults.color = '#555';

        function formatarLabel(label) {
            return label.replace(/_/g, ' ').split(' ');
        }

        // --- Gráfico Região (Doughnut) ---
        const dadosRegiao = {
            labels: [{% for i in dados_regiao %} "{{i._id}}", {% endfor %}],
            data: [{% for i in dados_regiao %} {{i.count}}, {% endfor %}]
        };
        
        new Chart(document.getElementById('chartRegiao'), {
            type: 'doughnut',
            data: {
                labels: dadosRegiao.labels,
                datasets: [{
                    data: dadosRegiao.data,
                    backgroundColor: ['#3155A4', '#AA4400', '#FFB511', '#198754', '#6c757d', '#20c997'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: 20 },
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 10, padding: 15 } },
                    datalabels: { color: '#fff', font: { weight: 'bold', size: 11 }, formatter: (value) => value }
                }
            }
        });

        // --- Gráfico Natureza (Barra Horizontal) ---
        const rawLabelsNat = [{% for i in dados_natureza %} "{{i._id}}", {% endfor %}];
        const formattedLabelsNat = rawLabelsNat.map(label => formatarLabel(label));
        const dadosNat = { data: [{% for i in dados_natureza %} {{i.count}}, {% endfor %}] };

        new Chart(document.getElementById('chartNatureza'), {
            type: 'bar',
            data: {
                labels: formattedLabelsNat,
                datasets: [{
                    label: 'Ocorrências',
                    data: dadosNat.data,
                    backgroundColor: '#3155A4',
                    borderRadius: 4,
                    barPercentage: 0.7
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { right: 30 } },
                scales: {
                    x: { display: false },
                    y: { ticks: { font: { size: 11, weight: '600' }, autoSkip: false } }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: { anchor: 'end', align: 'end', color: '#3155A4', font: { weight: 'bold' }, formatter: (value) => value }
                }
            }
        });

        // --- Gráfico Gravidade (Barra Vertical) ---
        const dadosGrav = {
            labels: [{% for i in dados_massivo %} {% if i._id == 0 %} "Normal" {% elif i._id == 1 %} "Nível 1" {% else %} "Nível 2" {% endif %}, {% endfor %}],
            data: [{% for i in dados_massivo %} {{i.count}}, {% endfor %}]
        };

        new Chart(document.getElementById('chartGravidade'), {
            type: 'bar',
            data: {
                labels: dadosGrav.labels,
                datasets: [{
                    data: dadosGrav.data,
                    backgroundColor: ['#28a745', '#fd7e14', '#dc3545'],
                    borderRadius: 5,
                    barThickness: 40
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { top: 25 } },
                scales: {
                    y: { display: false, grace: '15%' },
                    x: { grid: { display: false } }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: { anchor: 'end', align: 'top', color: '#555', font: { weight: 'bold' } }
                }
            }
        });
    </script>

</body>
</html>
